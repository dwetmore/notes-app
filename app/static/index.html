<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Notes App</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #edf2f7;
      --bg-accent: #d6e6f7;
      --card: #ffffffcc;
      --text: #101827;
      --muted: #4b5565;
      --border: #d0d9e6;
      --primary: #14532d;
      --primary-text: #f6fff8;
      --danger: #b42318;
      --danger-text: #fff6f5;
      --soft: #edf7f0;
      --shadow: 0 14px 30px rgba(16, 24, 39, 0.12);
    }
    body[data-theme="dark"] {
      color-scheme: dark;
      --bg: #0b1220;
      --bg-accent: #152238;
      --card: #101a2ecc;
      --text: #eaf0f7;
      --muted: #9cb0c9;
      --border: #26344d;
      --primary: #7fe6aa;
      --primary-text: #062413;
      --danger: #ff7b75;
      --danger-text: #2f0d0b;
      --soft: #122438;
      --shadow: 0 18px 34px rgba(0, 0, 0, 0.4);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: "IBM Plex Sans", "Avenir Next", "Segoe UI", sans-serif;
      background:
        radial-gradient(1200px 500px at 0% 0%, var(--bg-accent), transparent 68%),
        radial-gradient(900px 400px at 100% 100%, var(--soft), transparent 62%),
        var(--bg);
      color: var(--text);
    }
    .wrap {
      width: min(1080px, 100%);
      margin: 0 auto;
      padding: 24px 16px 48px;
    }
    h1 {
      margin: 0 0 4px;
      font-size: clamp(30px, 4vw, 42px);
      line-height: 1.05;
      letter-spacing: -0.03em;
      font-family: "Space Grotesk", "IBM Plex Sans", "Avenir Next", sans-serif;
    }
    .sub { color: var(--muted); margin: 0; }
    .topbar { display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; flex-wrap: wrap; margin-bottom: 12px; }
    .actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .pill {
      display: inline-flex; align-items: center; gap: 8px; font-size: 12px;
      padding: 7px 10px; border-radius: 999px; border: 1px solid var(--border);
      color: var(--muted); background: var(--card); backdrop-filter: blur(6px);
    }
    .card {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      margin: 14px 0;
      background: var(--card);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow);
    }
    .section-title { margin: 0 0 10px; font-size: 13px; letter-spacing: .03em; text-transform: uppercase; color: var(--muted); font-weight: 700; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .stack { display: grid; gap: 10px; }
    label.meta { color: var(--muted); font-size: 12px; font-weight: 600; letter-spacing: .02em; }
    input, textarea, select {
      width: 100%;
      padding: 11px 13px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      background: transparent;
      color: var(--text);
    }
    input::placeholder, textarea::placeholder { color: var(--muted); }
    textarea { min-height: 108px; resize: vertical; }
    button {
      padding: 10px 14px;
      border: 0; border-radius: 10px; cursor: pointer;
      font-weight: 700; letter-spacing: .01em;
      transition: transform 120ms ease, opacity 120ms ease;
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    button:disabled { opacity: .55; cursor: not-allowed; transform: none; }
    .btn { background: var(--primary); color: var(--primary-text); }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .danger { background: var(--danger); color: var(--danger-text); }
    .meta { color: var(--muted); font-size: 12px; margin: 0; }
    .alert { min-height: 18px; }
    .notes-grid { display: grid; gap: 12px; }
    .note-title { font-weight: 700; margin: 0 0 6px; font-size: 18px; }
    .note-body { margin: 0; white-space: pre-wrap; color: var(--text); }
    .note-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .attachment-wrap { margin-top: 12px; border-top: 1px dashed var(--border); padding-top: 12px; }
    .attachment-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .attachments-list { margin-top: 8px; display: grid; gap: 6px; }
    .attachment-item {
      display: flex; justify-content: space-between; align-items: center; gap: 10px;
      padding: 8px 10px; border: 1px solid var(--border); border-radius: 10px; background: var(--soft);
    }
    .attachment-preview {
      margin-top: 8px;
      width: min(260px, 100%);
      border: 1px solid var(--border);
      border-radius: 10px;
      display: block;
    }
    .attachment-link { color: var(--primary); text-decoration: none; font-size: 13px; font-weight: 600; word-break: break-all; }
    .attachment-link:hover { text-decoration: underline; }
    .chipbar { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .chip {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      background: transparent;
      color: var(--text);
    }
    .chip.active { background: var(--primary); color: var(--primary-text); border-color: transparent; }
    .badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 4px 8px; border-radius: 999px;
      font-size: 11px; border: 1px solid var(--border); color: var(--muted);
    }
    .history-list { max-height: 200px; overflow: auto; display: grid; gap: 8px; margin-top: 8px; }
    .history-item { border: 1px solid var(--border); border-radius: 10px; padding: 8px; background: var(--soft); }
    @media (max-width: 760px) {
      .row { grid-template-columns: 1fr; }
      .card { padding: 14px; border-radius: 14px; }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <div class="topbar">
      <div>
        <h1>Notes</h1>
        <p class="sub">Tags, pinning, archive, history, and share links.</p>
      </div>
      <div class="actions">
        <label class="pill"><span>Theme</span><button id="theme-toggle" class="btn-outline" type="button">Dark</button></label>
        <button class="btn" onclick="refreshNotes()">Refresh</button>
      </div>
    </div>

    <div class="card">
      <p class="section-title">Write Note</p>
      <div class="stack">
        <div class="row">
          <div>
            <label class="meta">Title</label>
            <input id="title" placeholder="e.g., Demo checklist" />
          </div>
          <div>
            <label class="meta">Tags (comma-separated)</label>
            <input id="tags" placeholder="ops, urgent, personal" />
          </div>
        </div>
        <div class="row">
          <div>
            <label class="meta">Body</label>
            <textarea id="body" placeholder="Type something..."></textarea>
          </div>
          <div class="stack">
            <label class="meta">Actions</label>
            <div class="note-actions">
              <button id="save-btn" class="btn" onclick="submitNote()">Add note</button>
              <button class="btn-outline" onclick="clearForm()">Clear</button>
              <button id="cancel-btn" class="btn-outline" onclick="cancelEdit()" style="display:none;">Cancel edit</button>
              <label class="pill"><input id="pinned" type="checkbox" /> Pin this note</label>
            </div>
            <div class="row">
              <div>
                <label class="meta">Search</label>
                <input id="search" placeholder="Search notes by title/body/tags" />
              </div>
              <div>
                <label class="meta">Visibility</label>
                <label class="pill"><input id="show-archived" type="checkbox" /> Include archived</label>
              </div>
            </div>
          </div>
        </div>
      </div>
      <p id="msg" class="meta alert" style="margin-top:10px;"></p>
      <div id="tag-chips" class="chipbar"></div>
    </div>

    <div class="card">
      <p class="section-title">Quick Upload</p>
      <div class="row">
        <div>
          <label class="meta">Target note</label>
          <select id="upload-note-select"></select>
        </div>
        <div>
          <label class="meta">File</label>
          <input id="top-file" type="file" />
        </div>
      </div>
      <div class="note-actions" style="margin-top:12px;">
        <button id="top-upload-btn" class="btn" type="button" onclick="uploadFromTop()">Upload to selected note</button>
      </div>
    </div>

    <div id="notes" class="notes-grid"></div>
  </main>

<script>
async function api(path, opts = {}) {
  const headers = { ...(opts.headers || {}) };
  if (!(opts.body instanceof FormData) && !headers["Content-Type"]) headers["Content-Type"] = "application/json";
  const r = await fetch(path, { ...opts, headers });
  if (!r.ok) {
    const t = await r.text();
    throw new Error(`${r.status} ${r.statusText}: ${t}`);
  }
  if (r.status === 204) return null;
  const contentType = r.headers.get("content-type") || "";
  return contentType.includes("application/json") ? r.json() : r.text();
}

async function apiWithTimeout(path, opts = {}, timeoutMs = 20000) {
  let timer = null;
  const timeout = new Promise((_, reject) => {
    timer = setTimeout(() => reject(new Error("request timed out")), timeoutMs);
  });
  try {
    return await Promise.race([api(path, opts), timeout]);
  } finally {
    if (timer) clearTimeout(timer);
  }
}

let editingId = null;
let activeTag = "";
const notesCache = new Map();

function parseTagInput(raw) {
  return String(raw || "")
    .split(",")
    .map(s => s.trim().toLowerCase())
    .filter(Boolean)
    .filter((v, i, arr) => arr.indexOf(v) === i);
}

function clearForm() {
  document.getElementById("title").value = "";
  document.getElementById("body").value = "";
  document.getElementById("tags").value = "";
  document.getElementById("pinned").checked = false;
}

function updateFormState() {
  const saveBtn = document.getElementById("save-btn");
  const cancelBtn = document.getElementById("cancel-btn");
  if (editingId) {
    saveBtn.textContent = "Save changes";
    cancelBtn.style.display = "inline-flex";
  } else {
    saveBtn.textContent = "Add note";
    cancelBtn.style.display = "none";
  }
}

function cancelEdit() {
  editingId = null;
  clearForm();
  updateFormState();
}

function startEdit(id) {
  const note = notesCache.get(id);
  if (!note) return;
  editingId = id;
  document.getElementById("title").value = note.title;
  document.getElementById("body").value = note.body;
  document.getElementById("tags").value = (note.tags || []).join(", ");
  document.getElementById("pinned").checked = !!note.pinned;
  updateFormState();
}

async function submitNote() {
  const title = document.getElementById("title").value.trim();
  const body = document.getElementById("body").value.trim();
  const tags = parseTagInput(document.getElementById("tags").value);
  const pinned = document.getElementById("pinned").checked;
  const msg = document.getElementById("msg");
  msg.textContent = "";
  if (!title || !body) {
    msg.textContent = "Title and body are required.";
    return;
  }
  try {
    const payload = { title, body, tags, pinned };
    if (editingId) {
      await api(`/api/notes/${editingId}`, { method: "PUT", body: JSON.stringify(payload) });
      msg.textContent = "Updated.";
    } else {
      await api("/api/notes", { method: "POST", body: JSON.stringify(payload) });
      msg.textContent = "Saved.";
    }
    editingId = null;
    clearForm();
    updateFormState();
    await refreshNotes();
  } catch (e) {
    msg.textContent = String(e);
  }
}

async function archiveNote(id) {
  if (!confirm(`Archive note ${id}?`)) return;
  try {
    await api(`/api/notes/${id}/archive`, { method: "POST" });
    await refreshNotes();
  } catch (e) {
    alert(String(e));
  }
}

async function unarchiveNote(id) {
  try {
    await api(`/api/notes/${id}/unarchive`, { method: "POST" });
    await refreshNotes();
  } catch (e) {
    alert(String(e));
  }
}

async function purgeNote(id) {
  if (!confirm(`Permanently delete note ${id} and all attachments/history?`)) return;
  try {
    await api(`/api/notes/${id}/purge`, { method: "DELETE" });
    await refreshNotes();
  } catch (e) {
    alert(String(e));
  }
}

async function pinToggle(id, shouldPin) {
  const note = notesCache.get(id);
  if (!note) return;
  try {
    await api(`/api/notes/${id}`, {
      method: "PUT",
      body: JSON.stringify({
        title: note.title,
        body: note.body,
        tags: note.tags || [],
        pinned: shouldPin,
      }),
    });
    await refreshNotes();
  } catch (e) {
    alert(String(e));
  }
}

async function createShare(id) {
  try {
    const resp = await api(`/api/notes/${id}/share`, { method: "POST" });
    const full = `${window.location.origin}${resp.share_url}`;
    let copied = false;
    if (navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
      await navigator.clipboard.writeText(full);
      copied = true;
    } else {
      const input = document.createElement("input");
      input.value = full;
      document.body.appendChild(input);
      input.select();
      copied = document.execCommand("copy");
      document.body.removeChild(input);
    }
    if (copied) {
      document.getElementById("msg").textContent = `Share link copied: ${full}`;
    } else {
      document.getElementById("msg").innerHTML = `Share link: <a class="attachment-link" href="${escapeHtml(resp.share_url)}" target="_blank">${escapeHtml(full)}</a>`;
    }
    await refreshNotes();
  } catch (e) {
    document.getElementById("msg").textContent = `Share error: ${String(e)}`;
  }
}

async function showHistory(id) {
  const holder = document.getElementById(`history-${id}`);
  if (!holder) return;
  holder.innerHTML = `<p class="meta">Loading history...</p>`;
  try {
    const entries = await api(`/api/notes/${id}/history`);
    if (!entries.length) {
      holder.innerHTML = `<p class="meta">No history yet.</p>`;
      return;
    }
    holder.innerHTML = `<div class="history-list">${entries.map(item => `
      <div class="history-item">
        <div class="meta"><strong>${escapeHtml(item.action)}</strong> at ${escapeHtml(item.created_at)}</div>
        <div class="meta">title: ${escapeHtml(item.title)} | tags: ${escapeHtml((item.tags || []).join(", ") || "none")} | pinned: ${item.pinned ? "yes" : "no"} | archived: ${item.archived ? "yes" : "no"}</div>
      </div>
    `).join("")}</div>`;
  } catch (e) {
    holder.innerHTML = `<p class="meta">History error: ${escapeHtml(String(e))}</p>`;
  }
}

function formatBytes(bytes) {
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KiB`;
  return `${(bytes / (1024 * 1024)).toFixed(1)} MiB`;
}

async function uploadAttachmentToNote(noteId, fileInput) {
  const msg = document.getElementById("msg");
  const file = fileInput.files[0];
  if (!file) {
    msg.textContent = "Choose a file first.";
    return;
  }
  const formData = new FormData();
  formData.append("file", file);
  try {
    await api(`/api/notes/${noteId}/attachments`, { method: "POST", body: formData });
    msg.textContent = `Uploaded ${file.name}.`;
    fileInput.value = "";
    await refreshNotes();
  } catch (e) {
    msg.textContent = String(e);
  }
}

async function uploadAttachment(noteId) {
  const input = document.getElementById(`file-${noteId}`);
  if (!input) return;
  await uploadAttachmentToNote(noteId, input);
}

async function uploadFromTop() {
  const select = document.getElementById("upload-note-select");
  const input = document.getElementById("top-file");
  const noteId = Number(select.value);
  if (!noteId) {
    document.getElementById("msg").textContent = "Create or select a note first.";
    return;
  }
  await uploadAttachmentToNote(noteId, input);
}

async function deleteAttachment(attachmentId) {
  if (!confirm(`Delete attachment ${attachmentId}?`)) return;
  try {
    await api(`/api/attachments/${attachmentId}`, { method: "DELETE" });
    await refreshNotes();
  } catch (e) {
    alert(String(e));
  }
}

function renderTagChips(items) {
  const el = document.getElementById("tag-chips");
  const tags = Array.from(new Set(items.flatMap(n => n.tags || []))).sort();
  const allClass = activeTag ? "chip" : "chip active";
  el.innerHTML = `<button class="${allClass}" type="button" onclick="setActiveTag('')">All tags</button>` +
    tags.map(t => `<button class="${activeTag === t ? "chip active" : "chip"}" type="button" onclick="setActiveTag('${escapeHtml(t)}')">#${escapeHtml(t)}</button>`).join("");
}

function setActiveTag(tag) {
  activeTag = tag;
  refreshNotes();
}

function renderUploadTargets(items) {
  const select = document.getElementById("upload-note-select");
  const current = select.value;
  const active = items.filter(n => !n.archived);
  if (!active.length) {
    select.innerHTML = `<option value="">No active notes</option>`;
    select.disabled = true;
    document.getElementById("top-upload-btn").disabled = true;
    return;
  }
  select.disabled = false;
  document.getElementById("top-upload-btn").disabled = false;
  select.innerHTML = active.map(n => `<option value="${n.id}">#${n.id} ${escapeHtml(n.title)}</option>`).join("");
  if (current && select.querySelector(`option[value="${current}"]`)) select.value = current;
}

function renderNotes(items) {
  const el = document.getElementById("notes");
  notesCache.clear();
  renderUploadTargets(items);
  renderTagChips(items);
  if (!items.length) {
    el.innerHTML = `<div class="card"><p class="meta">No notes found.</p></div>`;
    return;
  }
  items.forEach(n => notesCache.set(n.id, n));
  el.innerHTML = items.map(n => `
    <div class="card">
      <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap: wrap;">
        <div style="flex:1; min-width: 220px;">
          <p class="note-title">${n.pinned ? "ðŸ“Œ " : ""}${escapeHtml(n.title)} <span class="meta">#${n.id}</span></p>
          <p class="note-body">${escapeHtml(n.body)}</p>
          <div class="note-actions" style="margin-top:8px;">
            ${(n.tags || []).map(t => `<span class="badge">#${escapeHtml(t)}</span>`).join("")}
            ${n.archived ? `<span class="badge">Archived</span>` : ``}
          </div>
        </div>
        <div class="note-actions">
          <button class="btn-outline" onclick="startEdit(${n.id})">Edit</button>
          <button class="btn-outline" onclick="pinToggle(${n.id}, ${!n.pinned})">${n.pinned ? "Unpin" : "Pin"}</button>
          ${n.archived
            ? `<button class="btn-outline" onclick="unarchiveNote(${n.id})">Unarchive</button>`
            : `<button class="btn-outline" onclick="archiveNote(${n.id})">Archive</button>`
          }
          <button class="btn-outline" onclick="createShare(${n.id})">Share</button>
          <button class="danger" onclick="purgeNote(${n.id})">Purge</button>
        </div>
      </div>
      ${n.share_url ? `<p class="meta" style="margin-top:8px;">Share: <a class="attachment-link" href="${escapeHtml(n.share_url)}" target="_blank">${escapeHtml(n.share_url)}</a></p>` : ``}
      <div class="attachment-wrap">
        <p class="meta" style="margin-bottom:8px;">Attachments</p>
        <div class="attachment-row">
          <input id="file-${n.id}" type="file" style="max-width:320px;" ${n.archived ? "disabled" : ""} />
          <button class="btn-outline" onclick="uploadAttachment(${n.id})" ${n.archived ? "disabled" : ""}>Upload file</button>
          <button class="btn-outline" onclick="showHistory(${n.id})">History</button>
        </div>
        <div id="history-${n.id}"></div>
        <div class="attachments-list" id="attachments-${n.id}">
          <p class="meta">Loading attachments...</p>
        </div>
      </div>
    </div>
  `).join("");
  items.forEach(loadAttachments);
}

async function loadAttachments(noteId) {
  const el = document.getElementById(`attachments-${noteId}`);
  if (!el) return;
  try {
    const attachments = await apiWithTimeout(`/api/notes/${noteId}/attachments`, {}, 15000);
    if (!attachments.length) {
      el.innerHTML = `<p class="meta">No files yet.</p>`;
      return;
    }
    el.innerHTML = attachments.map(a => `
      <div class="attachment-item">
        <div style="min-width:0; flex:1;">
          <a class="attachment-link" href="${escapeHtml(a.download_url)}" target="_blank">${escapeHtml(a.filename)}</a>
          ${String(a.content_type || "").startsWith("image/")
            ? `<img class="attachment-preview" src="${escapeHtml(a.download_url)}?inline=1" alt="${escapeHtml(a.filename)}" />`
            : ``}
        </div>
        <div class="note-actions">
          <span class="meta">${formatBytes(a.size_bytes)}</span>
          <button class="btn-outline" onclick="deleteAttachment(${a.id})">Remove</button>
        </div>
      </div>
    `).join("");
  } catch (e) {
    el.innerHTML = `<p class="meta">Attachment error: ${escapeHtml(String(e))}</p>`;
  }
}

function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[c]));
}

async function refreshNotes() {
  try {
    const term = document.getElementById("search").value.trim();
    const includeArchived = document.getElementById("show-archived").checked;
    const params = new URLSearchParams();
    if (term) params.set("search", term);
    if (activeTag) params.set("tag", activeTag);
    if (includeArchived) params.set("include_archived", "true");
    const suffix = params.toString() ? `?${params.toString()}` : "";
    const items = await api(`/api/notes${suffix}`);
    renderNotes(items);
  } catch (e) {
    document.getElementById("notes").innerHTML = `<div class="card"><p class="meta">Error: ${escapeHtml(String(e))}</p></div>`;
  }
}

const themeToggle = document.getElementById("theme-toggle");
const savedTheme = localStorage.getItem("theme") || "light";
document.body.dataset.theme = savedTheme;
themeToggle.textContent = savedTheme === "dark" ? "Light" : "Dark";

themeToggle.addEventListener("click", () => {
  const next = document.body.dataset.theme === "dark" ? "light" : "dark";
  document.body.dataset.theme = next;
  localStorage.setItem("theme", next);
  themeToggle.textContent = next === "dark" ? "Light" : "Dark";
});

document.getElementById("search").addEventListener("input", refreshNotes);
document.getElementById("show-archived").addEventListener("change", refreshNotes);

updateFormState();
refreshNotes();
</script>
</body>
</html>
