<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Notes App</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #f7f7fb;
      --card: #ffffff;
      --text: #14161a;
      --muted: #5b6470;
      --border: #d8dde6;
      --primary: #1f2a44;
      --primary-text: #ffffff;
      --danger: #b00020;
      --danger-text: #ffffff;
      --shadow: 0 8px 24px rgba(20, 22, 26, 0.08);
    }
    body[data-theme="dark"] {
      color-scheme: dark;
      --bg: #0f1218;
      --card: #171c25;
      --text: #f3f5f7;
      --muted: #98a2b3;
      --border: #2a3344;
      --primary: #7c95ff;
      --primary-text: #0f1218;
      --danger: #ff5a71;
      --danger-text: #1a0f12;
      --shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      max-width: 980px;
      margin: 40px auto;
      padding: 0 16px 48px;
      background: var(--bg);
      color: var(--text);
    }
    h1 { margin: 0 0 6px; }
    .sub { color: var(--muted); margin: 0 0 18px; }
    .card {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      margin: 14px 0;
      background: var(--card);
      box-shadow: var(--shadow);
    }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .stack { display: grid; gap: 10px; }
    input, textarea {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      background: transparent;
      color: var(--text);
    }
    input::placeholder, textarea::placeholder { color: var(--muted); }
    textarea { min-height: 110px; resize: vertical; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; font-weight: 600; }
    .btn { background: var(--primary); color: var(--primary-text); }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .danger { background: var(--danger); color: var(--danger-text); }
    .note-title { font-weight: 700; margin: 0 0 6px; }
    .note-body { margin: 0; white-space: pre-wrap; color: var(--text); }
    .meta { color: var(--muted); font-size: 12px; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap: 16px; flex-wrap: wrap; }
    .actions { display:flex; gap: 8px; align-items:center; }
    .notes-grid { display: grid; gap: 12px; }
    .note-actions { display: flex; gap: 8px; }
    .attachment-wrap { margin-top: 12px; border-top: 1px dashed var(--border); padding-top: 12px; }
    .attachment-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .attachments-list { margin-top: 8px; display: grid; gap: 6px; }
    .attachment-item { display: flex; justify-content: space-between; align-items: center; gap: 10px; padding: 8px 10px; border: 1px solid var(--border); border-radius: 10px; }
    .attachment-link { color: var(--primary); text-decoration: none; font-size: 13px; }
    .attachment-link:hover { text-decoration: underline; }
    .pill { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; padding: 6px 10px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted); }
  </style>
</head>
<body>
  <div class="topbar">
    <div>
      <h1>Notes</h1>
      <p class="sub">A tiny FastAPI + Kubernetes demo app.</p>
    </div>
    <div class="actions">
      <label class="pill">
        <span>Theme</span>
        <button id="theme-toggle" class="btn-outline" type="button">Dark</button>
      </label>
      <button class="btn" onclick="refreshNotes()">Refresh</button>
    </div>
  </div>

  <div class="card">
    <div class="stack">
      <div class="row">
        <div>
          <label class="meta">Title</label>
          <input id="title" placeholder="e.g., Demo checklist" />
        </div>
        <div>
          <label class="meta">Body</label>
          <textarea id="body" placeholder="Type something..."></textarea>
        </div>
      </div>
      <div class="row">
        <div>
          <label class="meta">Search</label>
          <input id="search" placeholder="Search notes by title or body" />
        </div>
        <div class="stack">
          <span class="meta">Actions</span>
          <div style="display:flex; gap:10px; flex-wrap: wrap;">
            <button id="save-btn" class="btn" onclick="submitNote()">Add note</button>
            <button class="btn-outline" onclick="clearForm()">Clear</button>
            <button id="cancel-btn" class="btn-outline" onclick="cancelEdit()" style="display:none;">Cancel edit</button>
          </div>
        </div>
      </div>
    </div>
    <p id="msg" class="meta" style="margin-top:10px;"></p>
  </div>

  <div id="notes" class="notes-grid"></div>

<script>
async function api(path, opts={}) {
  const headers = { ...(opts.headers || {}) };
  if (!(opts.body instanceof FormData) && !headers["Content-Type"]) {
    headers["Content-Type"] = "application/json";
  }
  const r = await fetch(path, { ...opts, headers });
  if (!r.ok) {
    const t = await r.text();
    throw new Error(`${r.status} ${r.statusText}: ${t}`);
  }
  if (r.status === 204) {
    return null;
  }
  const contentType = r.headers.get("content-type") || "";
  if (contentType.includes("application/json")) {
    return r.json();
  }
  return r.text();
}

let editingId = null;
const notesCache = new Map();

function clearForm() {
  document.getElementById("title").value = "";
  document.getElementById("body").value = "";
}

function updateFormState() {
  const saveBtn = document.getElementById("save-btn");
  const cancelBtn = document.getElementById("cancel-btn");
  if (editingId) {
    saveBtn.textContent = "Save changes";
    cancelBtn.style.display = "inline-flex";
  } else {
    saveBtn.textContent = "Add note";
    cancelBtn.style.display = "none";
  }
}

function cancelEdit() {
  editingId = null;
  clearForm();
  updateFormState();
}

function startEdit(id) {
  const note = notesCache.get(id);
  if (!note) return;
  editingId = id;
  document.getElementById("title").value = note.title;
  document.getElementById("body").value = note.body;
  updateFormState();
}

async function submitNote() {
  const title = document.getElementById("title").value.trim();
  const body = document.getElementById("body").value.trim();
  const msg = document.getElementById("msg");
  msg.textContent = "";

  if (!title || !body) {
    msg.textContent = "Title and body are required.";
    return;
  }

  try {
    if (editingId) {
      await api(`/api/notes/${editingId}`, { method: "PUT", body: JSON.stringify({ title, body }) });
      msg.textContent = "Updated.";
    } else {
      await api("/api/notes", { method: "POST", body: JSON.stringify({ title, body }) });
      msg.textContent = "Saved.";
    }
    clearForm();
    editingId = null;
    updateFormState();
    await refreshNotes();
  } catch (e) {
    msg.textContent = String(e);
  }
}

async function deleteNote(id) {
  if (!confirm(`Delete note ${id}?`)) return;
  try {
    await api(`/api/notes/${id}`, { method: "DELETE" });
    await refreshNotes();
  } catch (e) {
    alert(String(e));
  }
}

function formatBytes(bytes) {
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KiB`;
  return `${(bytes / (1024 * 1024)).toFixed(1)} MiB`;
}

async function uploadAttachment(noteId) {
  const input = document.getElementById(`file-${noteId}`);
  const msg = document.getElementById("msg");
  const file = input.files[0];
  if (!file) {
    msg.textContent = "Choose a file first.";
    return;
  }
  const formData = new FormData();
  formData.append("file", file);
  try {
    await api(`/api/notes/${noteId}/attachments`, { method: "POST", body: formData });
    msg.textContent = `Uploaded ${file.name}.`;
    input.value = "";
    await refreshNotes();
  } catch (e) {
    msg.textContent = String(e);
  }
}

async function deleteAttachment(attachmentId) {
  if (!confirm(`Delete attachment ${attachmentId}?`)) return;
  try {
    await api(`/api/attachments/${attachmentId}`, { method: "DELETE" });
    await refreshNotes();
  } catch (e) {
    alert(String(e));
  }
}

function renderNotes(items) {
  const el = document.getElementById("notes");
  notesCache.clear();
  if (!items.length) {
    el.innerHTML = `<div class="card"><p class="meta">No notes yet. Add one above.</p></div>`;
    return;
  }
  items.forEach(n => notesCache.set(n.id, n));
  el.innerHTML = items.map(n => `
    <div class="card">
      <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start;">
        <div style="flex:1;">
          <p class="note-title">${escapeHtml(n.title)} <span class="meta">#${n.id}</span></p>
          <p class="note-body">${escapeHtml(n.body)}</p>
        </div>
        <div class="note-actions">
          <button class="btn-outline" onclick="startEdit(${n.id})">Edit</button>
          <button class="danger" onclick="deleteNote(${n.id})">Delete</button>
        </div>
      </div>
      <div class="attachment-wrap">
        <p class="meta">Attachments</p>
        <div class="attachment-row">
          <input id="file-${n.id}" type="file" style="max-width:280px;" />
          <button class="btn-outline" onclick="uploadAttachment(${n.id})">Upload file</button>
        </div>
        <div class="attachments-list" id="attachments-${n.id}">
          <p class="meta">Loading attachments...</p>
        </div>
      </div>
    </div>
  `).join("");
  items.forEach(loadAttachments);
}

async function loadAttachments(noteId) {
  const el = document.getElementById(`attachments-${noteId}`);
  if (!el) return;
  try {
    const attachments = await api(`/api/notes/${noteId}/attachments`);
    if (!attachments.length) {
      el.innerHTML = `<p class="meta">No files yet.</p>`;
      return;
    }
    el.innerHTML = attachments.map(a => `
      <div class="attachment-item">
        <a class="attachment-link" href="${escapeHtml(a.download_url)}">${escapeHtml(a.filename)}</a>
        <div class="note-actions">
          <span class="meta">${formatBytes(a.size_bytes)}</span>
          <button class="btn-outline" onclick="deleteAttachment(${a.id})">Remove</button>
        </div>
      </div>
    `).join("");
  } catch (e) {
    el.innerHTML = `<p class="meta">Attachment error: ${escapeHtml(String(e))}</p>`;
  }
}

function escapeHtml(s) {
  return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

async function refreshNotes() {
  try {
    const term = document.getElementById("search").value.trim();
    const url = term ? `/api/notes?search=${encodeURIComponent(term)}` : "/api/notes";
    const items = await api(url);
    renderNotes(items);
  } catch (e) {
    document.getElementById("notes").innerHTML = `<div class="card"><p class="meta">Error: ${escapeHtml(String(e))}</p></div>`;
  }
}

const themeToggle = document.getElementById("theme-toggle");
const savedTheme = localStorage.getItem("theme") || "light";
document.body.dataset.theme = savedTheme;
themeToggle.textContent = savedTheme === "dark" ? "Light" : "Dark";

themeToggle.addEventListener("click", () => {
  const next = document.body.dataset.theme === "dark" ? "light" : "dark";
  document.body.dataset.theme = next;
  localStorage.setItem("theme", next);
  themeToggle.textContent = next === "dark" ? "Light" : "Dark";
});

document.getElementById("search").addEventListener("input", () => {
  refreshNotes();
});

updateFormState();
refreshNotes();
</script>
</body>
</html>
